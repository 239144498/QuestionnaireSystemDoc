- [前端详细设计-V1.0](#前端详细设计-v10)
- [1. 登录/注册模块](#1-登录注册模块)
  * [1.1 模块设计](#11-模块设计)
    + [路由表](#路由表)
    + [对应接口信息](#对应接口信息)
  * [1.2 核心代码](#12-核心代码)
    + [Login.vue](#loginvue)
    + [Register.vue](#registervue)
- [2. 问卷管理模块](#2-问卷管理模块)
  * [2.1 模块设计](#21-模块设计)
    + [路由表](#路由表-1)
    + [对应接口信息](#对应接口信息-1)
  * [2.2 核心代码](#22-核心代码)
    + [List.vue](#listvue)
    + [Create.vue](#createvue)
    + [Statistic.vue](#statisticvue)
- [3. 问卷查看与提交模块](#3-问卷查看与提交模块)
  * [3.1 模块设计](#31-模块设计)
    + [路由表](#路由表-2)
    + [对应接口信息](#对应接口信息-2)
  * [3.2 核心代码](#32-核心代码)
    + [Naire.vue](#nairevue)
- [4. 管理员模块](#4-管理员模块)
  * [4.1 模块设计](#41-模块设计)
    + [路由表](#路由表-3)
    + [对应接口信息](#对应接口信息-3)
  * [4.2 核心代码](#42-核心代码)
    + [UserManage.vue](#usermanagevue)
    + [QuestionNaireManage.vue](#questionnairemanagevue)

# 前端详细设计-V1.0

> 备注：基础功能详细设计 
>
> 代码仅供参考思路 具体实现可能有修改

| 作者 | 版本号 | 日期 | 变更说明 |
|---- | ---- | ---- | ---- |
| 谢韦杭 | V1.0 |2020.06.07| 初始化文档 |
| 谢韦杭 | V1.0 |2020.07.07| 新建 登录/注册模块、问卷管理模块、问卷查看与提交模块、管理员模块 |

# 1. 登录/注册模块

## 1.1 模块设计

- 登录
  * 可跳转到注册页面
  * 访问登录页面时，检查 cookie，如果已登录则跳转至问卷管理页面
  * 访问登录页面时，向后端发送请求，获取验证码
  * 登录信息提交前，检查每个字段是否合法
  * 登录失败时，重新获取验证码
  * 登录成功时，跳转至问卷管理页面
- 注册
  * 可跳转到登录页面
  * 获取邮箱验证码时，在用户填写完邮箱且邮箱合法时，向后端发送请求，向该邮箱发送验证邮件
  * 注册信息提交前，检查每个字段是否合法
  * 注册成功后，重定向至登录页面

### 路由表

```JSON
{
    path: '/login',
    name: 'Login',
},
{
    path: '/register',
    name: 'Register',
}
```

### 对应接口信息

[登录验证码 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E7%A0%81api)

[登录 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95api)

[邮箱验证码 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%82%AE%E7%AE%B1%E9%AA%8C%E8%AF%81%E7%A0%81api)

[注册 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8Capi)

## 1.2 核心代码

### Login.vue

```js
import axios from 'axios';
import baseURL from "../config";

export default {
    name: "Login",
    data() {
        return {
            check_code_url: '',
            form: {
                email: '',
                pwd: '',
                check_code: '',
            },
            rules: {
                email: [
                    {
                        required: true,
                        message: '请输入邮箱',
                        trigger: 'blur',
                    }
                ],
                pwd: [
                    {
                        required: true,
                        message: '请输入密码',
                        trigger: 'blur',
                    }
                ],
                check_code: [
                    {
                        required: true,
                        message: '请输入验证码',
                        trigger: 'blur',
                    }
                ]
            }
        };
    },
    methods: {
        // 获取验证码
        get_check_code() {
            this.check_code_url = `${baseURL}/checkCode/?time=${Date.now()}`;
        },
        // 登录表单提交
        handleSubmit(name) {
            // 验证合法性
            this.$refs[name].validate((valid) => {
                if (valid) {
                    // 合法
                    const payload = this.form;
                    axios.post('/login/', payload)
                        .then(() => {
                            if (this.$route.params.redirect) {
                                this.$router.push({ path: this.$route.params.redirect });
                            } else {
                                this.$router.push({ name: 'Manage' });
                            }
                        })
                        .catch((error) => {
                            switch (error.status) {
                                case 403:
                                    switch (error.msg) {
                                        case 1:
                                            this.$message.error('用户名或密码错误');
                                            break;
                                        case 2:
                                            this.$message.error('验证码错误');
                                            break;
                                        case 100:
                                            this.$message.error('请将信息填写完整');
                                            break;
                                        default:
                                            this.$message.error('其他错误');
                                    }
                                    break;
                                default:
                                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                            }
                            this.get_check_code()
                        })
                } else {
                    this.$message.error('信息填写有误')
                    this.get_check_code()
                }
            })
        }
    },
    created() {
        if (this.$cookies.isKey('user')) {
            this.$router.push({ name: 'Manage' });
        }
        this.get_check_code();
    }
}
```

### Register.vue

```js
import axios from "axios";

export default {
    name: "Register",
    data() {
        return {
            form: {
                email: '',
                usrname: '',
                birth: '',
                pwd: '',
                email_code: '',
                sex: '',
            },
            rules: {
                email: [
                    {
                        required: true,
                        message: '请输入邮箱',
                        trigger: 'blur',
                    },
                    {
                        pattern: '^([A-Za-z0-9_\\-\\.\u4e00-\u9fa5])+\\@([A-Za-z0-9_\\-\\.])+\\.([A-Za-z]{2,8})$',
                        message: '请输入正确的邮箱',
                    }
                ],
                email_code: [
                    {
                        required: true,
                        message: '请输入验证码',
                        trigger: 'blur',
                    }
                ],
                pwd: [
                    {
                        required: true,
                        message: '请输入密码',
                        trigger: 'blur',
                    },
                    {
                        pattern: '^[A-Za-z0-9]+$',
                        message: '密码只允许由大写字母、小写字母和数字组成'
                    }
                ],
                usrname: [
                    {
                        required: true,
                        message: '请输入用户名',
                        trigger: 'blur',
                    }
                ],
                birth: [
                    {
                        required: true,
                        message: '请选择生日',
                        trigger: 'blur',
                    }
                ],
                sex: [
                    {
                        required: true,
                        message: '请选择性别',
                        trigger: 'blur',
                    }
                ]
            },
            btn: {
                text: '获取验证码',
                disabled: false,
                cd: 0,
            },
        }
    },
    methods: {
        get_email_code(name) {
            const pattern = '^([A-Za-z0-9_\\-\\.\u4e00-\u9fa5])+\\@([A-Za-z0-9_\\-\\.])+\\.([A-Za-z]{2,8})$';
            const re = new RegExp(pattern);
            const email = this.$refs[name].model.email;
            if (re.test(email)) {
                const payload = {
                    email: email,
                }
                axios.post('/emailCode/', payload)
                    .then(() => {
                        this.btn.cd = 60;
                        this.btn.disabled = true;
                        this.btn.text = this.btn.cd + 's 后可重发';
                        let cool_down = setInterval(() => {
                            if (this.btn.cd < 1) {
                                this.btn.disabled = false;
                                this.btn.text = '获取验证码';
                                this.btn.cd = 60;
                                clearInterval(cool_down);
                            } else {
                                this.btn.text = --this.btn.cd + 's 后可重发';
                            }
                        }, 1000);
                        this.$message.success('验证码发送成功，请注意查收');
                    })
                    .catch((error) => {
                        switch (error.msg) {
                            case 1:
                                this.$message.error('邮件发送失败，可能是邮箱服务器出了问题');
                                break;
                            case 100:
                                this.$message.error('请填写邮箱！');
                                break;
                            default:
                                this.$message.error('网络连接超时，请检查网络或稍后再试')
                        }
                    })
            } else {
                this.$message.error('请输入正确的邮箱');
            }
        },
        // 注册表单提交
        handleSubmit(name) {
            this.$refs[name].validate((valid) => {
                if (valid) {
                    let payload = { ...this.form };
                    payload.birth /= 1000;
                    axios.post('/register/', payload)
                        .then(() => {
                            this.$message.success('注册成功');
                            this.$router.push({ name: 'Login' });
                        })
                        .catch((error) => {
                            switch (error.status) {
                                case 403:
                                    switch (error.msg) {
                                        case 1:
                                            this.$message.error('邮箱已注册，请换一个邮箱，或使用该邮箱登录');
                                            break;
                                        case 2:
                                            this.$message.error('邮箱验证码错误');
                                            break;
                                        case 3:
                                            this.$message.error('密码只允许由大写字母、小写字母和数字组成');
                                            break;
                                        case 100:
                                            this.$message.error('请将信息填写完整');
                                            break;
                                        default:
                                            this.$message.error('其他错误');
                                    }
                                    break;
                                default:
                                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                            }
                        })
                } else {
                    this.$message.error('信息填写有误')
                }
            })
        },
    }
}
```

# 2. 问卷管理模块

## 2.1 模块设计

- 问卷管理
  * 访问问卷管理页面时，向后端发送请求，获取当前用户的问卷列表
  * 点击问卷管理页面的“创建问卷”或点击左侧的设计问卷，跳转到问卷设计页面
  * 点击未发布的问卷可以编辑该问卷，点击已发布和已停用的问卷可跳转到问卷填写页面
  * 可以发布状态为“未发布”的问卷
  * 可以查看已发布和已停用的问卷的统计分析信息
  * 可以获取已停用的问卷的全部填写结果、
  * 可以删除当前用户创建的问卷
- 问卷设计
  * 访问问卷设计页面时，如果路由中未指定问卷 ID，弹出对话框提示创建问卷
  * 从路由中获取问卷 ID，向后端请求问卷信息和问卷内容
  * 可任意添加问题，题型包括单选题、多选题、文本题
  * 单选题和多选题可任意添加选项
  * 可修改问卷名称
  * 可保存问卷
  * 点击“发布问卷”，弹出对话框设置问卷截止时间，设置完成后可发布
- 统计分析
  * 从路由中获取问卷 ID，向后端请求问卷统计信息，使用 ECharts 显示条形图
  * 可查看单选题和多选题选择每个选项的数量
  * 如果问卷题型只有选择题，且选项均为代表分值的纯数字，可使用打分模式，统计每个打分项目的平均分和打分次数

### 路由表

```JSON
{
    path: '/manage',
    name: 'Manage',
    meta:
    {
        require_auth: true
    },
    redirect: List,
    children: [
        {
            path: '',
            name: 'List',
            meta:
            {
                navIndex: '/manage',
                title: '我的问卷',
                require_auth: true
            }
        },
        {
            path: 'create',
            name: 'Create',
            meta:
            {
                navIndex: '/manage/create',
                title: '创建问卷',
                require_auth: true
            }
        },
        {
            path: 'create/:id',
            name: 'Edit',
            meta:
            {
                navIndex: '/manage/create',
                title: '设计问卷',
                require_auth: true
            }
        },
        {
            path: 'statistic/:id',
            name: 'Statistic',
            meta:
            {
                navIndex: '/manage',
                title: '统计分析',
                require_auth: true
            }
        }
    ]
}
```

### 对应接口信息

[当前用户问卷列表 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E9%97%AE%E5%8D%B7%E5%88%97%E8%A1%A8api)

[修改问卷名称 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E4%BF%AE%E6%94%B9%E9%97%AE%E5%8D%B7%E5%90%8Dapi)

[问卷发布 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%8F%91%E5%B8%83api)

[问卷停用 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%81%9C%E7%94%A8api)

[问卷删除 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%88%A0%E9%99%A4api)

[问卷创建 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%88%9B%E5%BB%BAapi)

[问卷重命名 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E4%BF%AE%E6%94%B9%E9%97%AE%E5%8D%B7%E5%90%8Dapi)

[问卷保存 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E4%BF%9D%E5%AD%98api)

[问卷内容获取 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%86%85%E5%AE%B9%E8%8E%B7%E5%8F%96api)

[问卷结果全量 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E7%BB%93%E6%9E%9C%E5%85%A8%E9%87%8Fapi)

[问卷结果统计 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E7%BB%93%E6%9E%9C%E7%BB%9F%E8%AE%A1api)

## 2.2 核心代码

### List.vue

```js
import axios from 'axios'
import baseURL from "../config";

export default {
    name: "List",
    data() {
        return {
            NaireList: [],
            loading: false,
            selectContent: [],
            showDeadlineDialog: false,
            showChangeDeadlineDialog: false,
            publish_form: {
                Q_ID: '',
                end_date: '',
            },
            datePickerOptions: {
                disabledDate(date) {
                    const currentDate = Date.now();
                    return (date && date.valueOf() < currentDate) || (date && date.valueOf() > currentDate + 2592000000);
                }
            },
        }
    },
    methods: {
        getList() {
            this.loading = true;
            const path = '/userQuestionnaireList/';
            axios.get(path)
                .then((res) => {
                    this.NaireList = res.data;
                })
                .catch(() => {
                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                })
            this.loading = false;
        },
        create() {
            this.$router.push({ name: 'Create' })
        },
        batchDelete() {
            this.$confirm('确认删除选中的问卷吗？', '批量删除', {
                type: 'warning'
            })
                .then(async () => {
                    this.selectContent.forEach((item) => {
                        this.deleteNaire(item.Q_ID);
                    })
                })
                .catch(() => { });
        },
        onSelectionChange(val) {
            this.selectContent = val
        },
        onOptionClick(command, row) {
            switch (command) {
                case 'preview':
                    this.$router.push({ name: 'View naire', params: { id: row.Q_ID } });
                    break;
                case 'result':
                    window.open(`${baseURL}/questionnaireResultGet/?Q_ID=${row.Q_ID}`, '_blank');
                    break;
                case 'edit':
                    this.$router.push({ name: 'Edit', params: { id: row.Q_ID } });
                    break;
                case 'stop':
                    this.stopNaire(row.Q_ID);
                    break;
                case 'publish':
                    this.publish_form.Q_ID = row.Q_ID;
                    this.showDeadlineDialog = true;
                    break;
                case 'delete':
                    this.deleteNaire(row.Q_ID);
                    break;
            }
        },
        stopNaire(q_id) {
            const path = '/questionnaireInactive/';
            const payload = {
                Q_ID: q_id,
            };
            axios.post(path, payload)
                .then(() => {
                    this.$message.success('问卷停用成功');
                    this.getList();
                })
                .catch((error) => {
                    switch (error.msg) {
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
        },
        async deleteNaire(id) {
            const path = '/questionnaireDelete/';
            const payload = {
                Q_ID: id,
            };
            axios.post(path, payload)
                .then(() => {
                    this.$message.success('问卷删除成功');
                    this.getList();
                })
                .catch((error) => {
                    switch (error.msg) {
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
        },
        handlePublish() {
            if (this.publish_form.Q_ID !== '' && this.publish_form.end_date !== '') {
                const path = '/questionnairePublish/';
                const payload = { ...this.publish_form };
                payload.end_date /= 1000;
                axios.post(path, payload)
                    .then(() => {
                        this.showDeadlineDialog = false;
                        this.publish_form.Q_ID = '';
                        this.publish_form.end_date = '';
                        this.$message.success('发布成功');
                        this.getList();
                    })
                    .catch((error) => {
                        switch (error.msg) {
                            case 2:
                                this.$message.error('请选择正确的截止日期');
                                break;
                            case 100:
                                this.$message.error('请将信息填写完整');
                                break;
                            default:
                                this.$message.error('网络连接超时，请检查网络或稍后再试');
                        }
                    })
            } else {
                this.$message.error('请将信息填写完整');
            }
        },
        handleCancelPublish() {
            this.showDeadlineDialog = false;
            this.publish_form.Q_ID = '';
            this.publish_form.end_date = '';
        },
        handleGetResult(row) {
            this.$router.push({ name: 'Statistic', params: { id: row.Q_ID } });
        }
    },
    filters: {
        formatDate(val) {
            const timestamp = new Date(Number(val) * 1000)
            return !val ? '' : timestamp.getFullYear() + '-' + (timestamp.getMonth() + 1) + '-' + timestamp.getDate()
        },
        stateFilter(val) {
            switch (val) {
                case 0:
                    return '未发布';
                case 1:
                    return '已发布';
                case 2:
                    return '已停止';
                case 3:
                    return '已删除';
            }
        },
        stateColorFilter(val) {
            switch (val) {
                case 0:
                    return 'primary';
                case 1:
                    return 'success';
                case 2:
                    return 'info';
                case 3:
                    return 'danger'
            }
        }
    },
    created() {
        this.getList();
    }
}
```

### Create.vue

```js
import QuestionList from "./Question/QuestionList";
import axios from 'axios';

export default {
    name: "Create",
    components: {
        QuestionList
    },
    data() {
        return {
            Q_ID: '',
            showCreateDialog: false,
            showDeadlineDialog: false,
            title_form: {
                Q_title: '',
            },
            end_date: undefined,
            title_rules: {
                Q_title: [
                    {
                        required: true,
                        message: '请输入问卷标题',
                        trigger: 'blur',
                    }
                ]
            },
            naire: {
                Q_ID: '',
                Q_name: '',
                content: []
            },
            rules: {
                title: [
                    { required: true, message: '请输入问卷标题', trigger: 'blur' }
                ],
                deadline: [
                    { required: true, message: '请选择截止时间', trigger: 'blur' }
                ]
            },
            datePickerOptions: {
                disabledDate(date) {
                    const currentDate = Date.now();
                    return (date && date.valueOf() < currentDate) || (date && date.valueOf() > currentDate + 2592000000);
                }
            },
        }
    },
    methods: {
        getTitle() {
            const path = `/questionnaireInfo/?Q_ID=${this.Q_ID}`
            axios.get(path)
                .then((res) => {
                    this.naire.Q_name = res.data.Q_Name;
                })
                .catch((error) => {
                    console.log(error)
                    switch (error.msg) {
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
        },
        getNaire() {
            const path = `/questionnaireGet/?Q_ID=${this.Q_ID}`;
            axios.get(path)
                .then((res) => {
                    this.naire = res.data;
                })
                .catch(() => {
                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                });
        },
        onAddOption({ index }) {
            const tempData = {
                option_content: '选项',
            }
            this.naire.content[index].option.push({ ...tempData })
        },
        onDelOption({ index, opIndex }) {
            if (this.naire.content[index].option.length < 2) {
                return this.$message.warning('已经是最后一个选项，无法删除。')
            }
            this.naire.content[index].option.splice(opIndex, 1)
        },
        onDelQuestion({ index }) {
            this.naire.content.splice(index, 1)
        },
        addQuestion(type) {
            let ques = {
                question_type: type,
            };
            switch (type) {
                case 0:
                    ques.question_content = '单选题目';
                    ques.option = [
                        {
                            option_content: '选项',
                        }
                    ];
                    break;
                case 1:
                    ques.question_content = '多选题目';
                    ques.option = [
                        {
                            option_content: '选项',
                        }
                    ];
                    break;
                case 2:
                    ques.question_content = '文本题目';
                    break;
            }
            this.naire.content.push(ques);
        },
        async saveTitle() {
            let ret = false;
            const path = '/questionnaireRename/';
            const payload = {
                Q_ID: this.Q_ID,
                Q_Name: this.naire.Q_name,
            }
            await axios.post(path, payload)
                .then(() => {
                    ret = true;
                })
                .catch((error) => {
                    switch (error.msg) {
                        case 1:
                            this.$message.error('保存失败');
                            break;
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                });
            return ret;
        },
        async saveContent() {
            let ret = false;
            for (let ques_index = 0; ques_index < this.naire.content.length; ques_index++) {
                this.naire.content[ques_index].question_id = ques_index;
                if (this.naire.content[ques_index].option) {
                    for (let op_index = 0; op_index < this.naire.content[ques_index].option.length; op_index++) {
                        this.naire.content[ques_index].option[op_index].option_id = op_index;
                    }
                }
            }
            const path = '/questionnaireSave/'
            const payload = this.naire;
            await axios.post(path, payload)
                .then(() => {
                    ret = true;
                })
                .catch((error) => {
                    switch (error.msg) {
                        case 2:
                            this.$message.error('保存失败');
                            break;
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
            return ret;
        },
        async save() {
            let flag1 = await this.saveTitle();
            let flag2 = await this.saveContent();
            if (flag1 && flag2) {
                this.$message.success('保存成功');
            }
        },
        async publish() {
            await this.save();
            const path = '/questionnairePublish/';
            const payload = {
                Q_ID: this.Q_ID,
                end_date: this.end_date / 1000,
            }
            axios.post(path, payload)
                .then(() => {
                    this.$message.success('发布成功');
                    this.$router.push({ name: 'Manage' });
                })
                .catch((error) => {
                    switch (error.msg) {
                        case 2:
                            this.$message.error('问卷截止时间有误')
                            break;
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
        },
        handleCreate() {
            this.$refs['title_form'].validate((valid) => {
                if (valid) {
                    const path = '/questionnaireCreate/';
                    const payload = this.title_form;
                    axios.post(path, payload)
                        .then(async (res) => {
                            this.showCreateDialog = false;
                            this.Q_ID = this.naire.Q_ID = res.data.Q_ID;
                            await this.saveContent()
                            await this.$router.push({ name: 'Edit', params: { id: res.data.Q_ID } });
                            this.getTitle();
                        })
                        .catch((error) => {
                            switch (error.msg) {
                                case 100:
                                    this.$message.error('请将信息填写完整');
                                    break;
                                default:
                                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                            }
                        })
                }
            });
        },
        handleCancelCreate() {
            this.$router.push({ name: 'Manage' })
        },
    },
    created() {
        if (!this.$route.params.id) {
            this.showCreateDialog = true;
        } else {
            this.Q_ID = this.$route.params.id;
            this.getTitle();
            this.getNaire();
        }
    }
}
```

### Statistic.vue

```js
import axios from 'axios'
import echarts from 'echarts'

export default {
    name: "Statistic",
    data() {
        return {
            loading: false,
            scoreMode: false,
            Q_ID: '',
            results: [],
            scoreTable: [],
        }
    },
    methods: {
        async getStatisticResult() {
            this.loading = true;
            const path = `/questionnaireStatistics/?Q_ID=${this.Q_ID}`;
            await axios.get(path)
                .then((res) => {
                    this.results = res.data;
                })
                .catch((error) => {
                    switch (error.msg) {
                        case 1:
                            this.$router.push({ name: '404' });
                            break;
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
            this.loading = false;
            this.$nextTick(async () => {
                await this.drawCharts();
            })
        },
        async drawCharts() {
            let chartsList = [];
            await this.results.forEach((result, index) => {
                let optionContent = [];
                let optionCount = [];
                for (let i = 0; i < result.option.length; i++) {
                    optionContent.push(result.option[i].option_content);
                    optionCount.push(result.option[i].option_count);
                }
                let chart = echarts.init(document.getElementById('chart-' + index))
                let option = {
                    color: ['#3398DB'],
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: optionContent,
                            axisTick: {
                                alignWithLabel: true
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: [
                        {
                            name: '人数',
                            type: 'bar',
                            barWidth: '20%',
                            data: optionCount
                        }
                    ]
                };
                chart.setOption(option);
                chartsList.push(chart)
            })
            window.onresize = async () => {
                chartsList.forEach((chart) => {
                    chart.resize();
                })
            }
        },
        validate() {
            let valid = true;
            this.results.forEach((result) => {
                result.option.forEach((op) => {
                    if (isNaN(Number(op.option_content))) {
                        valid = false;
                    }
                })
            })
            return valid;
        },
        async score() {
            this.scoreTable = [];
            this.results.forEach((result) => {
                let sum = 0;
                let count = 0
                result.option.forEach((op) => {
                    sum += Number(op.option_content * op.option_count);
                    count += op.option_count;
                })
                let avg = sum / count;
                this.scoreTable.push({
                    question_content: result.question_content,
                    count: count,
                    score: avg.toFixed(2),
                })
            })
        },
        handleChange(mode) {
            if (mode) {
                if (this.validate()) {
                    this.scoreMode = true;
                    this.score();
                } else {
                    this.scoreMode = false;
                    this.$message.warning('该问卷暂不支持切换模式');
                }
            } else {
                this.scoreMode = false;
                this.getStatisticResult();
            }
        }
    },
    created() {
        this.Q_ID = this.$route.params.id;
        this.getStatisticResult();
    }
}
```

# 3. 问卷查看与提交模块

## 3.1 模块设计

- 访问不可访问的问卷时，重定向至 404 页面
- 从路由中获取问卷 ID，向后端请求问卷信息和问卷内容
- 仅状态为“已发布”的问卷可提交
- 提交问卷时，检查是否已全部填写，如果还有未填写内容，输出提示信息
- 问卷提交成功后，跳转到提交成功页面

### 路由表

```JSON
{
    path: '/naire/:id',
    name: 'View naire',
}
```

### 对应接口信息

[问卷信息 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E4%BF%A1%E6%81%AFapi)

[问卷内容获取 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%86%85%E5%AE%B9%E8%8E%B7%E5%8F%96api)

[问卷提交 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E6%8F%90%E4%BA%A4api)

## 3.2 核心代码

### Naire.vue

```js
import axios from 'axios';
import QuestionList from "./Question/QuestionList";

export default {
    name: "Naire",
    components: {
        QuestionList,
    },
    data() {
        return {
            Q_ID: this.$route.params.id,
            info: {},
            naire: {},
            finished: false,
            loading: false,
        }
    },
    methods: {
        getInfo() {
            const path = `/questionnaireInfo/?Q_ID=${this.Q_ID}`;
            axios.get(path)
                .then((res) => {
                    this.info = res.data;
                })
                .catch((error) => {
                    switch (error.msg) {
                        case null:
                        case 1:
                            this.$router.push({ name: '404' });
                            break;
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
        },
        getNaire() {
            const path = `/questionnaireGet/?Q_ID=${this.Q_ID}`;
            axios.get(path)
                .then((res) => {
                    this.naire = res.data;
                })
                .catch((error) => {
                    switch (error.msg) {
                        case 100:
                            this.$message.error('请将信息填写完整');
                            break;
                        default:
                            this.$message.error('网络连接超时，请检查网络或稍后再试');
                    }
                })
        },
        validateNaire() {
            let valid = true;
            this.naire.content.forEach((item) => {
                switch (item.question_type) {
                    case 0:
                        if (item.op === undefined) {
                            valid = false
                        }
                        break;
                    case 1:
                        if (!(item.op && item.op.length > 0)) {
                            valid = false
                        }
                        break;
                    case 2:
                        if (!(item.text && item.text.trim().length > 0)) {
                            valid = false;
                        }
                        break;
                }
            })
            if (!valid) {
                this.$message.warning('请将问卷填写完整');
            }
            return valid;
        },
        submitNaire() {
            if (this.validateNaire()) {
                this.finished = true;
                const payload = {
                    Q_ID: this.Q_ID,
                    content: [],
                }
                this.naire.content.forEach((item) => {
                    let question_content = {
                        question_id: item.question_id,
                        question_type: item.question_type,
                    };
                    switch (item.question_type) {
                        case 0:
                            question_content.option = [item.op];
                            break;
                        case 1:
                            question_content.option = item.op.sort();
                            break;
                        case 2:
                            question_content.content = item.text;
                            break;
                    }
                    payload.content.push(question_content)
                })
                const path = '/questionnaireSubmit/';
                axios.post(path, payload)
                    .then(() => {
                        this.finished = false;
                        this.$router.push({ name: 'Complete' });
                    })
                    .catch((error) => {
                        switch (error.msg) {
                            case 1:
                                this.$message.error('格式错误');
                                break;
                            case 2:
                                this.$message.error('问卷不可用');
                                break;
                            case 100:
                                this.$message.error('请将问卷填写完整');
                                break;
                            default:
                                this.$message.error('网络连接超时，请检查网络或稍后再试');
                        }
                    })
            }
        },
    },
    filters: {
        formatDate(val) {
            const timestamp = new Date(Number(val) * 1000)
            return timestamp.getFullYear() + '-' + (timestamp.getMonth() + 1) + '-' + timestamp.getDate()
        },
    },
    created() {
        this.loading = true;
        this.getInfo();
        this.getNaire();
        this.loading = false;
    }
}
```

# 4. 管理员模块

## 4.1 模块设计

- 管理员可通过管理员登录页面登录管理页面
- 访问用户管理页面时，向后端请求用户列表
- 可在用户管理页面封禁或解封指定用户
- 访问问卷管理页面时，向后端请求问卷列表
- 可从问卷列表中跳转到指定问卷的填写页面
- 可在问卷管理页面删除或恢复指定问卷

### 路由表

```JSON
{
    path: '/admin/manage',
    name: 'Admin manage',
    redirect: '/admin/manage/user',
    children: [
        {
            path: 'user',
            name: 'Manage User',
            meta:
            {
                navIndex: '/admin/manage/user',
                title: '用户管理',
                require_admin: true
            }
        },
        {
            path: 'naire',
            name: 'Manage naire',
            meta:
            {
                navIndex: '/admin/manage/naire',
                title: '问卷管理',
                require_admin: true
            }
        }
    ]
}
```

### 对应接口信息

[管理员登录API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E5%BD%95api)

[管理员获取用户列表 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%AE%A1%E7%90%86%E5%91%98%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8api)

[管理员获取问卷列表 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%AE%A1%E7%90%86%E5%91%98%E8%8E%B7%E5%8F%96%E9%97%AE%E5%8D%B7%E5%88%97%E8%A1%A8api)

[管理员封禁/解封用户 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%AE%A1%E7%90%86%E5%91%98%E5%B0%81%E7%A6%81%E8%A7%A3%E5%B0%81%E7%94%A8%E6%88%B7api)

[管理员封禁/解封问卷 API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%AE%A1%E7%90%86%E5%91%98%E5%B0%81%E7%A6%81%E8%A7%A3%E5%B0%81%E9%97%AE%E5%8D%B7api)

## 4.2 核心代码

### UserManage.vue

```js
import axios from 'axios'

export default {
    name: "UserManage",
    data() {
        return {
            loading: false,
            UserList: [],
            offset: 0,
        }
    },
    methods: {
        getUserList(offset) {
            this.loading = true;
            const path = `/admin/userList/?offset=${offset}`;
            axios.get(path)
                .then((res) => {
                    this.UserList = res.data;
                })
                .catch(() => {
                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                })
            this.loading = false;
        },
        changeState(email, state) {
            const path = '/admin/userStateChange/';
            const payload = {
                email: email,
                type: state,
            }
            axios.post(path, payload)
                .then(() => {
                    this.getUserList(this.offset);
                })
                .catch(() => {
                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                })
        }
    },
    filters: {
        stateFilter(val) {
            switch (val) {
                case 0:
                    return '正常';
                case 1:
                    return '已封禁';
            }
        },
        stateColorFilter(val) {
            switch (val) {
                case 0:
                    return 'success';
                case 1:
                    return 'danger';
            }
        }
    },
    created() {
        this.getUserList(this.offset);
    }
}
```

### QuestionNaireManage.vue

```js
import axios from 'axios';

export default {
    name: "QuestionNaireManage",
    data() {
        return {
            loading: false,
            NaireList: [],
            offset: 0,
        }
    },
    methods: {
        getNaireList(offset) {
            this.loading = true;
            const path = `/admin/questionnaireList/?offset=${offset}`;
            axios.get(path)
                .then((res) => {
                    this.NaireList = res.data;
                })
                .catch(() => {
                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                })
            this.loading = false;
        },
        changeState(q_id, state) {
            const path = '/admin/questionnaireStateChange/';
            const payload = {
                Q_ID: q_id,
                type: state,
            }
            axios.post(path, payload)
                .then(() => {
                    this.getNaireList(this.offset);
                })
                .catch(() => {
                    this.$message.error('网络连接超时，请检查网络或稍后再试');
                })
        }
    },
    filters: {
        formatDate(val) {
            console.log(val);
            const timestamp = new Date(Number(val) * 1000)
            return !val ? '' : timestamp.getFullYear() + '-' + (timestamp.getMonth() + 1) + '-' + timestamp.getDate()
        },
        stateFilter(val) {
            switch (val) {
                case 0:
                    return '未发布';
                case 1:
                    return '已发布';
                case 2:
                    return '已停止';
                case 3:
                    return '已删除';
            }
        },
        stateColorFilter(val) {
            switch (val) {
                case 0:
                    return 'primary';
                case 1:
                    return 'success';
                case 2:
                    return 'info';
                case 3:
                    return 'danger'
            }
        }
    },
    created() {
        this.getNaireList(this.offset);
    }
}
```
