- [后端详细设计-V1.0](#后端详细设计-v10)
- [0. 验证码设计](#0-验证码设计)
  * [0.1 模块设计](#01-模块设计)
    + [路由表如下：](#-路由表如下)
    + [对应接口信息](#-对应接口信息)
  * [0.2 核心代码及说明](#02-核心代码及说明)
    + [class CheckcodeHandler](#class-checkcodehandler)
    + [class EmailCheckcodeHandler](#class-emailcheckcodehandler)
- [1. 用户管理模块设计](#1-用户管理模块设计)
  * [1.1 总体设计](#11-总体设计)
  * [1.2 数据库设计](#12-数据库设计)
  * [1.3 模块设计](#13-模块设计)
    + [路由表如下：](#路由表如下-1)
  * [1.4 核心代码及说明](#14-核心代码及说明)	
    + [class LoginHandler](#class-loginhandler)
    + [class RegisterHandler](#class-registerhandler)
    + [class UserInfoHandler](#class-userinfohandler)
    + [class UserChangePwdHandler](#class-userchangepwdhandler)
- [2. 问卷管理模块设计](#2-问卷管理模块设计)
  * [2.1 总体设计](#21-总体设计)
  * [2.2 数据库设计](#22-数据库设计)
  * [2.3 模块设计](#23-模块设计)
    + [路由表如下：](#路由表如下-2)
  * [2.4 核心代码及说明](#24-核心代码及说明)
    + [class QuestionnaireRename](#class-questionnairerename)
    + [class UserQuestionnaireListHandler](#class-userquestionnairelisthandler)
    + [class QuestionaireChangeStateHandler](#class-questionairechangestatehandler)
    + [class QuestionnaireDeleteHandler](#class-questionnairedeletehandler)
    + [class QuestionnaireInactiveHandler](#class-questionnaireinactivehandler)
    + [class QuestionnaireCreateHandler](#class-questionnairecreatehandler)
    + [class QuestionnaireSaveHandler](#class-questionnairesavehandler)
    + [class QuestionnaireContentHandler](#class-questionnairecontenthandler)
- [3. 答卷管理模块设计](#3-答卷管理模块设计)
  * [3.1 总体设计](#31-总体设计)
  * [3.2 数据库设计](#32-数据库设计)
  * [3.3 模块设计](#33-模块设计)
    + [路由表如下：](#路由表如下-3)
  * [3.4 核心代码及说明](#34-核心代码及说明)
	+ [class QuestionnaireSubmitHandler](#class-questionnairesubmithandler)
	+ [class QuestionnaireResultHandler](#class-questionnaireresulthandler)
	+ [class QuestionnaireStatisticsHandler](#class-questionnairestatisticshandler)
- [4. 管理员模块设计](#4-管理员模块设计)
  * [4.1 总体设计](#41-总体设计)
  * [4.2 数据库设计](#42-数据库设计)
  * [4.3 模块设计](#43-模块设计)
    + [路由表如下：](#路由表如下-4)
  * [4.4 核心代码及说明](#44-核心代码及说明)


# 后端详细设计-V1.0

> 备注：基础功能详细设计 

|  作者   | 版本号 | 日期 | 变更说明
|  ----  | ----   | ---- | ----  |
| 吉忠晟  | V1.0 |2020.05.15|新建 用户管理模块详细设计|
| 吉忠晟  | V1.0 |2020.05.27|完善 用户管理模块详细设计|
| 吉忠晟  | V1.0 |2020.05.27|完成 验证码设计|
| 吉忠晟  | V1.0 |2020.05.27|更新 管理员模块|
| 吉忠晟  | V1.0 |2020.05.27|更新 答卷模块|
| 吉忠晟  | V1.0 |2020.05.27|更新 问卷模块|
| 吉忠晟  | V1.0 |2020.06.06|完成 答卷模块|
| 吉忠晟  | V1.0 |2020.06.06|完成 问卷模块|
| 郭月琪  | V1.0 |TBD|完成 管理员模块|

# 0. 验证码设计

## 0.1 模块设计

- 针对登录验证码和邮箱验证码设计相应的Handler类，见`/APIHandler/CheckcodeHanler.py`
- 提供验证码图片生成、邮箱验证码发送函数，见`/source/checkCode.py`，`/source/emailCheckCode.py`
- 提供无状态HTTP服务，采用cookie方式暂存验证码内容
- 验证码的过期时间是10分钟，配置见`config.py`

### 路由表如下

	/api/v1/checkCode/ -----> <class 'APIHandler.CheckcodeHandler.CheckcodeHandler'>
	/api/v1/emailCode/ -----> <class 'APIHandler.CheckcodeHandler.EmailCheckcodeHandler'>

### 对应接口信息

[登录验证码API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E7%A0%81api)

[邮箱验证码API](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%82%AE%E7%AE%B1%E9%AA%8C%E8%AF%81%E7%A0%81api)

## 0.2 核心代码及说明

### class CheckcodeHandler

	class CheckcodeHandler(BaseHandler):
	    def get(self, *args, **kwargs):
	        # 返回验证码 set-cookie:check_code为验证码
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E7%A0%81api
	        imgio = io.BytesIO()
	        img, code = checkCode.create_validate_code()
	        img.save(imgio, 'GIF')
	        self.set_header("Content-Type", "image/gif")
	        self.write(imgio.getvalue())
	        # 10分钟过期的cookie
	        self.set_secure_cookie("check_code", code, expires_days=None, expires=time.time() + CHECK_CODE_EXPIRE_TIME)
	        if DEBUG:
	            print("DEBUG: Check Code Get:{}".format(code))

### class EmailCheckcodeHandler

	class EmailCheckcodeHandler(BaseHandler):
	    def initialize(self):
	        super(EmailCheckcodeHandler, self).initialize()
	        self.SEND_CHECK_CODE_FAIL = 1
	
	    async def post(self, *args, **kwargs):
	        # 向邮箱发送验证码，set-cookie:email_check_code为验证码内容
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%82%AE%E7%AE%B1%E9%AA%8C%E8%AF%81%E7%A0%81api
	        try:
	            json_data: dict = json.loads(self.request.body.decode('utf-8'))
	        except json.decoder.JSONDecodeError:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        email = json_data.get('email')
	        if not email:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        email_check_code = await emailCheckCode.send_email_checkcode(email)
	        if not email_check_code:
	            return self.raise_HTTP_error(403, self.SEND_CHECK_CODE_FAIL)
	        self.set_secure_cookie('email_check_code', email_check_code, expires_days=None,
	                               expires=time.time() + CHECK_CODE_EXPIRE_TIME)
	        if DEBUG:
	            print("DEBUG: Email Check Code Send:{}".format(email_check_code))


# 1. 用户管理模块设计

## 1.1 总体设计

[用户管理模块概要设计](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF%E6%A6%82%E8%A6%81%E8%AE%BE%E8%AE%A1-2020.05.14-V1.0.md#1-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97)

以上包括整体流程和接口定义。

## 1.2 数据库设计

![](https://raw.githubusercontent.com/Wh1isper/QuestionnaireSystemDoc/master/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/img/DataBaseV1.jpg)

说明：

- 用户状态：0为正常 1为封禁
- 用户密码：SHA256加密 存储16进制字符串
- 用户信息创建流程
	1. 用户信息表建立
	2. 初始化用户登录记录、用户密码

## 1.3 模块设计

- 针对每一个API设计一个Handler类，见`/APIHandler/UserManage/`
- 提供密码加密函数，见`/source/encrypt.py`
- 提供无状态HTTP服务，采用cookie方式暂存用户登录信息
- 用户授权时长为1天，相关配置见`config.py`

### 路由表如下

	/api/v1/login/ -----> <class 'APIHandler.UserManage.LoginHandler.LoginHandler'>
	/api/v1/logout/ -----> <class 'APIHandler.UserManage.LoginHandler.LogoutHandler'>
	/api/v1/register/ -----> <class 'APIHandler.UserManage.RegisterHandler.RegisterHandler'>
	/api/v1/userInfo/ -----> <class 'APIHandler.UserManage.UserInfoHandler.UserInfoHandler'>
	/api/v1/changePwd/ -----> <class 'APIHandler.UserManage.UserInfoHandler.UserChangePwdHandler'>

## 1.4 核心代码及说明

### class LoginHandler

	class LoginHandler(BaseHandler):
	    def initialize(self, pwd_salt):
	        super(LoginHandler, self).initialize()
	        self.USER_PWD_ERROR = 1
	        self.CHECK_CODE_ERROR = 2
	        self.PWD_SALT = pwd_salt
	
	    async def post(self, *args, **kwargs):
	        # 获取post请求数据 访问数据库进行用户验证并记录登录
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95api
	        # 成功将set-cookie:user 存有加密后的用户id
	        try:
	            json_data: dict = json.loads(self.request.body.decode('utf-8'))
	        except json.decoder.JSONDecodeError:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        email = json_data.get('email')
	        pwd = json_data.get('pwd')
	        check_code = json_data.get('check_code')
	        # 必填项确认
	        if not (email and pwd and check_code):
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        # 验证码确认
	        if not self.valid_checkcode(check_code):
	            return self.raise_HTTP_error(403, self.CHECK_CODE_ERROR)
	        # 用户鉴权
	        user_id = await self.valid_user(email, pwd)
	        if not user_id:
	            return self.raise_HTTP_error(403, self.USER_PWD_ERROR)
	        # 登录记录
	        await self.login_record(user_id)
	        # 发放权限
	        self.set_secure_cookie("user", user_id, expires_days=USER_AUTH_EXPIRE_DAY)

### class RegisterHandler

	class RegisterHandler(BaseHandler):
	    def initialize(self, pwd_salt):
	        super(RegisterHandler, self).initialize()
	        self.EMAIL_REPETITION = 1
	        self.EMAIL_CHECK_CODE_ERROR = 2
	        self.PWD_REG_CHECK_FAIL = 3
	        self.PWD_SALT = pwd_salt
	
	    async def post(self, *args, **kwargs):
	        # 用户注册 首先检查邮箱是否已经注册，再检查邮箱验证码和密码强度，最后写入数据库完成注册
	        # 写入数据库时需要初始化三个表，按以下顺序：UserInfo、UserPwd、UserLoginRecord
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8Capi
	        try:
	            json_data: dict = json.loads(self.request.body.decode('utf-8'))
	        except json.decoder.JSONDecodeError:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        # 参数读取
	        try:
	            email = json_data.get('email')
	            username = json_data.get('usrname')
	            birth = datetime.datetime.fromtimestamp(int(json_data.get('birth')))
	            pwd = json_data.get('pwd')
	            email_code = json_data.get('email_code')
	            sex = json_data.get('sex')
	        except:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        # 必填项确认
	        if not (email and username):
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        # 重复注册确认
	        if await self.email_is_registered(email):
	            return self.raise_HTTP_error(403, self.EMAIL_REPETITION)
	        # 邮箱验证码确认
	        if not self.valid_email_checkcode(email_code):
	            return self.raise_HTTP_error(403, self.EMAIL_CHECK_CODE_ERROR)
	        # 密码强度确认
	        if not self.valid_pwd_reg(pwd):
	            return self.raise_HTTP_error(403, self.PWD_REG_CHECK_FAIL)
	        # 进入注册流程：
	        usr_data_dict = {
	            'email': email,
	            'username': username,
	            'birth': birth,
	            'pwd': pwd,
	            'sex': sex,
	        }
	        await self.register(usr_data_dict)
	
	    async def register(self, data_dict: dict) -> bool:
	        # 注册流程：初始化三个表，按以下顺序：UserInfo、UserPwd、UserLoginRecord
	        async def register_user_info(data_dict: dict) -> int:
	            # 初始化用户信息并返回自增主键U_ID，途中出错返回503，由tornado接管
	            engine = await self.get_engine()
	            async with engine.acquire() as conn:
	                await conn.execute(
	                    UserInfoTable.insert().values(U_Email=data_dict.get('email'),
	                                                  U_Name=data_dict.get('username'),
	                                                  U_Sex=data_dict.get('sex'),
	                                                  U_Birth=data_dict.get('birth'),
	                                                  U_State=0))
	                # aiomysql bug .commit()方法不存在
	                # 这里直接调用实现即可 or conn.execute('commit')
	                await conn._commit_impl()
	                result = await conn.execute(
	                    UserInfoTable.select().where(UserInfoTable.c.U_Email == data_dict.get('email')))
	                userinfo = await result.fetchone()
	            if userinfo:
	                return userinfo.U_ID
	            else:
	                return 0
	
	        async def register_user_pwd(data_dict: dict, u_id) -> bool:
	            # 初始化用户密码，途中出错返回503，由tornado接管
	            engine = await self.get_engine()
	            async with engine.acquire() as conn:
	                await conn.execute(
	                    UserPwdTable.insert().values(U_ID=u_id,
	                                                 U_Pwd=password_encrypt(data_dict.get('pwd'),
	                                                                        self.PWD_SALT)))
	                # aiomysql bug .commit()方法不存在
	                # 这里直接调用实现即可 or conn.execute('commit')
	                await conn._commit_impl()
	            return True
	
	        async def register_user_login_record(data_dict: dict, u_id) -> bool:
	            # 初始化用户登录信息，途中出错返回503，由tornado接管
	            engine = await self.get_engine()
	            async with engine.acquire() as conn:
	                await conn.execute(
	                    UserLoginRecordTable.insert().values(U_ID=u_id))
	                # aiomysql bug .commit()方法不存在
	                # 这里直接调用实现即可 or conn.execute('commit')
	                await conn._commit_impl()
	            return True
	
	        u_id = await register_user_info(data_dict)
	        if not u_id:
	            return False
	        await register_user_pwd(data_dict, u_id)
	        await register_user_login_record(data_dict, u_id)
	        return True

### class UserInfoHandler

	class UserInfoHandler(BaseHandler):
	    @authenticated
	    async def get(self, *args, **kwargs):
	        # 获取用户信息
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96api
	        engine = await self.get_engine()
	        async with engine.acquire() as conn:
	            result = await conn.execute(UserInfoTable.select()
	                                        .where(UserInfoTable.c.U_ID == self.current_user))
	            user_info = await result.fetchone()
	        birth = time.mktime(user_info.U_Birth.timetuple())
	        user_module = {
	            "email": user_info.U_Email,
	            "usrname": user_info.U_Name,
	            "sex": user_info.U_Sex,
	            "birth": birth,
	            "state": user_info.U_State,
	        }
	        self.write(user_module)
	
	    @authenticated
	    async def post(self, *args, **kwargs):
	        # 修改用户信息
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E4%BF%AE%E6%94%B9api
	        try:
	            json_data: dict = json.loads(self.request.body.decode('utf-8'))
	        except json.decoder.JSONDecodeError:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        try:
	            username = json_data.get('usrname')
	            birth = datetime.datetime.fromtimestamp(int(json_data.get('birth')))
	            sex = json_data.get('sex')
	        except:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        user_info_dict = {
	            'U_ID': self.current_user,
	            'username': username,
	            'birth': birth,
	            'sex': sex,
	        }
	        await self.update_user_info(user_info_dict)

### class UserChangePwdHandler

	class UserChangePwdHandler(BaseHandler):
	    def initialize(self, pwd_salt):
	        super(UserChangePwdHandler, self).initialize()
	        self.OLDPWD_ERROR = 1
	        self.PWD_REG_CHECK_FAIL = 2
	        self.PWD_SALT = pwd_salt
	
	    @authenticated
	    async def post(self, *args, **kwargs):
	        # 验证密码成功后修改用户密码
	        try:
	            json_data: dict = json.loads(self.request.body.decode('utf-8'))
	        except json.decoder.JSONDecodeError:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        old_pwd = json_data.get('old_pwd')
	        pwd = json_data.get('pwd')
	        # 必填项确认
	        if not (old_pwd and pwd):
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        # 验证密码
	        if not await self.valid_pwd(old_pwd):
	            return self.raise_HTTP_error(403, self.OLDPWD_ERROR)
	        # 验证新密码强度
	        if not self.valid_pwd_reg(pwd):
	            return self.raise_HTTP_error(403, self.PWD_REG_CHECK_FAIL)
	        # 更新密码
	        await self.update_pwd(pwd)


# 2. 问卷管理模块设计

## 2.1 总体设计

[问卷管理模块设计](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF%E6%A6%82%E8%A6%81%E8%AE%BE%E8%AE%A1-2020.05.14-V1.0.md#2-%E9%97%AE%E5%8D%B7%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97)

以上包括整体流程和接口定义。

## 2.2 数据库设计


![](https://raw.githubusercontent.com/Wh1isper/QuestionnaireSystemDoc/master/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/img/DataBaseV1.jpg)

说明：

- 问卷状态：0为未发布，1为已发布，2为停止，3为禁用
- 问卷暂存/保存时，将前端data写入问卷暂存表
- 当问卷发布时，将问卷暂存表内容取出，进行解析，更新问卷问题、问卷选项表
- 扩展需求：可由问卷ID进行扩展，保存填写者ip等限制


## 2.3 模块设计

- 针对每一个API设计一个Handler类，见`/APIHandler/QuestionnaireManage/`,`/APIHandler/UserQuestionnaire/`
- 提供无状态HTTP服务，采用cookie方式暂存用户登录信息

### 路由表如下

	/api/v1/questionnaireSave/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireContentHandler.QuestionnaireSave'>
	/api/v1/questionnaireGet/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireContentHandler.QuestionnaireContent'>
	/api/v1/questionnairePublish/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireStateHandler.QuestionnairePublishHandler'>
	/api/v1/questionnaireDelete/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireStateHandler.QuestionnaireDeleteHandler'>
	/api/v1/questionnaireInactive/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireStateHandler.QuestionnaireInactiveHandler'>
	/api/v1/userQuestionnaireList/ -----> <class 'APIHandler.UserQuestionnaire.UserQuestionnaireHandler.UserQuestionnaireListHandler'>
	/api/v1/questionnaireRename/ -----> <class 'APIHandler.UserQuestionnaire.QuestionnaireRenameHandler.QuestionnaireRename'>

## 2.4 核心代码及说明

### class QuestionnaireRename
	class QuestionnaireRename(BaseHandler):
	    def initialize(self):
	        super(QuestionnaireRename, self).initialize()
	        self.QUESTIONNAIRE_NOT_FOUND = 1
	
	    @authenticated
	    async def post(self, *args, **kwargs):
	        # 修改问卷名
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E4%BF%AE%E6%94%B9%E9%97%AE%E5%8D%B7%E5%90%8Dapi
	        # 1. 用户鉴权 确定是问卷的拥有者
	        # 2. 根据问卷ID直接修改
	        try:
	            json_data: dict = json.loads(self.request.body.decode('utf-8'))
	        except json.decoder.JSONDecodeError:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        q_id = json_data.get('Q_ID')
	        q_name = json_data.get('Q_Name')
	        if not (q_id and q_name):
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if not await self.valid_user_questionnaire_relation(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        await self.update_questionnaire_name(q_id, q_name)

### class UserQuestionnaireListHandler
	class UserQuestionnaireListHandler(BaseHandler):
	    @authenticated
	    async def get(self, *args, **kwargs):
	        # 获取当前用户问卷列表
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E7%94%A8%E6%88%B7%E9%97%AE%E5%8D%B7%E5%88%97%E8%A1%A8api
	        # 1. 获取用户 id:self.current_user
	        # 2. 查询数据库 获取用户id下的问卷信息
	        # 3. 打包返回
	        engine = await self.get_engine()
	        ret_list = []
	        async with engine.acquire() as conn:
	            result = await conn.execute(QuestionNaireInfoTable.select()
	                                        .where(QuestionNaireInfoTable.c.U_ID == self.current_user))
	            questionnaire_info_list = await result.fetchall()
	        for questionnaire_info in questionnaire_info_list:
	            info_module = {
	                "Q_ID":questionnaire_info.QI_ID,
	                "Q_Name":questionnaire_info.QI_Name,
	                "Q_creat_date":time.mktime(questionnaire_info.QI_Creat_Date.timetuple()),
	                "Q_deadline_date":time.mktime(questionnaire_info.QI_Deadline_Date.timetuple()),
	                "state":questionnaire_info.QI_State,
	            }
	            ret_list.append(json.dumps(info_module))
	        self.write(str(ret_list))

###class QuestionnairePublishHandler

	class QuestionnairePublishHandler(QuestionnaireBaseHandler):
	    def initialize(self):
	        super(QuestionnairePublishHandler, self).initialize()
	        self.QUESTIONNAIRE_NOT_FOUND = 1
	        self.BAD_END_DATE = 2
	
	    @xsrf
	    @authenticated
	    async def post(self, *args, **kwargs):
	        # 发布问卷
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%8F%91%E5%B8%83api
	        # 1. 验证问卷所属权
	        # 2. 修改问卷信息
	        # 3. 持久化存储问卷
	        json_data = self.get_json_data()
	        if not json_data:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        q_id = json_data.get('Q_ID')
	        end_date = datetime.datetime.fromtimestamp(int(json_data.get('end_date')))
	        if not await self.is_questionnaire_not_published(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        if not (q_id and end_date):
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if not await self.valid_user_questionnaire_relation(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        if not self.valid_date_duration(end_date):
	            return self.raise_HTTP_error(403, self.BAD_END_DATE)
	
	        questionnaire_module = {
	            'U_ID': self.current_user,
	            'Q_ID': q_id,
	            'end_date': end_date
	        }
	
	        if not await self.presistent_questionnaire(questionnaire_module):
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        await self.publish_quesitonnaire_info(questionnaire_module)

### class QuestionaireChangeStateHandler 
### class QuestionnaireDeleteHandler 
### class QuestionnaireInactiveHandler

	class QuestionaireChangeStateHandler(QuestionnaireBaseHandler):
	    def initialize(self, state):
	        super(QuestionaireChangeStateHandler, self).initialize()
	        self.QUESTIONNAIRE_NOT_FOUND = 1
	        self.STATE = state
	
	    @xsrf
	    @authenticated
	    async def post(self, *args, **kwargs):
	        # 更改问卷状态，子类应继承并配置state
	        # 1. 验证问卷所属权
	        # 2. 修改后问卷状态码不得变小（不得倒退）
	        # 3. 修改问卷信息
	        json_data = self.get_json_data()
	        if not json_data:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        q_id = json_data.get('Q_ID')
	        if not q_id:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if not self.valid_user_questionnaire_relation(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        if self.STATE < await self.get_questionnaire_state(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	
	        await self.change_questionnaire_state(q_id)
	
	    async def change_questionnaire_state(self, q_id: int) -> None:
	        # 这里不需要验证用户身份 之前已经验证过
	        engine = await self.get_engine()
	        async with engine.acquire() as conn:
	            await conn.execute(QuestionNaireInfoTable.update()
	                               .where(QuestionNaireInfoTable.c.QI_ID == q_id)
	                               .values(QI_State=self.STATE))
	            await conn._commit_impl()


	class QuestionnaireDeleteHandler(QuestionaireChangeStateHandler):
	    def initialize(self, state):
	        super(QuestionnaireDeleteHandler, self).initialize(state)
	
	
	class QuestionnaireInactiveHandler(QuestionaireChangeStateHandler):
	    def initialize(self, state):
	        super(QuestionnaireInactiveHandler, self).initialize(state)

### class QuestionnaireCreateHandler

	class QuestionnaireCreateHandler(QuestionnaireBaseHandler):
	    @xsrf
	    @authenticated
	    async def post(self, *args, **kwargs):
	        # 问卷创建
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%88%9B%E5%BB%BAapi
	        # 1. 获取问卷标题
	        # 2. 初始化问卷信息表QuestionNaireInfo, 问卷暂存表QuestionNaireTempTable, 答卷信息表AnswerRecorderTable
	        json_data = self.get_json_data()
	        if not json_data:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        title = json_data.get('Q_title')
	        if not title:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        q_id = await self.questionnaire_create(title)
	        self.write({'Q_ID': q_id})

### class QuestionnaireSaveHandler

	class QuestionnaireSaveHandler(QuestionnaireBaseHandler):
	    @xsrf
	    @authenticated
	    async def post(self, *args, **kwargs):
	        # 暂存问卷，不结构化存储，仅存储前端发回的数据
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E4%BF%9D%E5%AD%98api
	        # 1. 验证问卷所属权
	        # 2. 验证问卷状态：未发布
	        # 3. 保存问卷
	        json_data = self.get_json_data()
	        if not json_data:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        q_id = json_data.get('Q_ID')
	        if not q_id:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if not await self.valid_user_questionnaire_relation(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        if not await self.is_questionnaire_not_published(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_CANT_BE_CHANGED)
	        # 转字符串存储
	        q_content = json.dumps(json_data)
	        questionnaire_save_module = {
	            'Q_ID': q_id,
	            'Q_Content': q_content,
	        }
	        if not await self.save_questionnaire(questionnaire_save_module):
	            return self.raise_HTTP_error(403, self.MISSING_DATA)

### QuestionnaireContentHandler

	class QuestionnaireContentHandler(QuestionnaireBaseHandler):
	    @authenticated
	    async def get(self, *args, **kwargs):
	        # 拉取问卷内容，直接从暂存的信息中拉取
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E5%86%85%E5%AE%B9%E8%8E%B7%E5%8F%96api
	        # 1. 验证问卷状态
	        #   a. 未发布：仅所有者可查看
	        #   b. 停用、已发布：所有人均可查看
	        #   c. 禁用/删除：所有人均不可查看（管理员除外）
	        # 2. 拉取并返回
	        try:
	            q_id = int(self.get_query_argument('Q_ID'))
	        except ValueError:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if not q_id:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if await self._not_publish(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        if await self.is_questionnaire_be_banned(q_id) and not self.is_current_user_admin():
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        content = await self.get_questionnaire_data(q_id)
	        self.write(content)

# 3. 答卷管理模块设计

## 3.1 总体设计

[答卷管理模块设计](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF%E6%A6%82%E8%A6%81%E8%AE%BE%E8%AE%A1-2020.05.14-V1.0.md#3-%E7%AD%94%E5%8D%B7%E5%8F%8A%E7%BB%9F%E8%AE%A1%E6%A8%A1%E5%9D%97)

以上包括整体流程和接口定义。

## 3.2 数据库设计


![](https://raw.githubusercontent.com/Wh1isper/QuestionnaireSystemDoc/master/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/img/DataBaseV1.jpg)

说明：

- 答卷只考虑选项，将选项存储
- 利用问卷ID搜索所有答卷选项、问题


## 3.3 模块设计

- 针对每一个API设计一个Handler类，见`/APIHandler/QuestionnaireManage/QuestionnaireAnswerHandler.py`
- 提供无状态HTTP服务，采用cookie方式暂存用户登录信息

### 路由表如下

	/api/v1/questionnaireSubmit/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireAnswerHandler.QuestionnaireSubmit'>
	/api/v1/questionnaireResultGet/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireAnswerHandler.QuestionnaireResult'>
	/api/v1/questionnaireStatistics/ -----> <class 'APIHandler.QuestionnaireManage.QuestionnaireAnswerHandler.QuestionnaireStatistics'>

## 3.4 核心代码及说明

###class QuestionnaireSubmitHandler

	class QuestionnaireSubmitHandler(QuestionnaireBaseHandler):
	    def initialize(self):
	        super(QuestionnaireSubmitHandler, self).initialize()
	        self.PARSING_FAILED = 1
	        self.QUESTIONNAIRE_NOT_FOUND = 2
	
	    @xsrf
	    async def post(self, *arg, **kwargs):
	        # 问卷提交
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E6%8F%90%E4%BA%A4api
	        # 1. 解析数据
	        # 2. 验证问卷是发布状态
	        # 3. 记录提交次数、记录选项/填空项
	        # todo 日志管理 此模块失败需要记录日志
	        json_data = self.get_json_data()
	        if not json_data:
	            return self.raise_HTTP_error(403, self)
	        q_id = json_data.get('Q_ID')
	        if not await self.is_questionnaire_published(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        if not await self.save_answer(json_data):
	            return self.raise_HTTP_error(403, self.PARSING_FAILED)

###class QuestionnaireResultHandler

	class QuestionnaireResultHandler(QuestionnaireBaseHandler):
	    @xsrf
	    @authenticated
	    async def get(self, *args, **kwargs):
	        # 问卷结果全量导出，仅接受查询停用的问卷
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E7%BB%93%E6%9E%9C%E5%85%A8%E9%87%8Fapi
	        # 1. 用户鉴权
	        # 2. 问卷状态检查
	        # 3. 查找是否有csv缓存，若无，则将查询结果写入csv，返回文件名
	        # 4. 提供csv下载服务
	        try:
	            q_id = int(self.get_query_argument('Q_ID'))
	        except:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if not await self.valid_user_questionnaire_relation(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        if not await self.is_questionnaire_inactivate(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	        filename = await self.get_all_result(q_id)
	        self.set_header("Content-Type", "text/csv")
	        self.set_header('Content-Disposition', 'attachment; filename=' + 'Result')
	        with open(filename, 'rb') as f:
	            while True:
	                data = f.read(2048)
	                if not data:
	                    break
	                self.write(data)
	        self.finish()

###class QuestionnaireStatisticsHandler

	class QuestionnaireStatisticsHandler(QuestionnaireBaseHandler):
	    @xsrf
	    @authenticated
	    async def get(self, *args, **kwargs):
	        # 问卷结果统计，支持实时查看
	        # 接口约定：https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89/%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1-2020.05.17-V1.0.md#%E9%97%AE%E5%8D%B7%E7%BB%93%E6%9E%9C%E7%BB%9F%E8%AE%A1api
	        # 1. 获取问卷下所有题号->题目
	        # 2. 根据题号获取选项号->选项内容->计数
	        # todo redis缓存优化
	        try:
	            q_id = int(self.get_query_argument('Q_ID'))
	        except:
	            return self.raise_HTTP_error(403, self.MISSING_DATA)
	        if not await self.valid_user_questionnaire_relation(q_id):
	            return self.raise_HTTP_error(403, self.QUESTIONNAIRE_NOT_FOUND)
	
	        engine = await self.get_engine()
	        async with engine.acquire() as conn:
	            result = await conn.execute(AnswerOptionTable.select()
	                                        .where(AnswerOptionTable.c.QI_ID == q_id)
	                                        .where(or_(AnswerOptionTable.c.QO_Type == 0, AnswerOptionTable.c.QO_Type == 1))
	                                        .distinct()
	                                        .with_only_columns([AnswerOptionTable.c.QQ_ID])
	                                        )
	            qq_ids = await result.fetchall()
	
	        return_list = []
	        for qq_id in qq_ids:
	            qq_id = qq_id[0]
	            option_list = []
	            question_content = await self.get_question_content(q_id, qq_id)
	            async with engine.acquire() as conn:
	                result = await conn.execute(AnswerOptionTable.select()
	                                            .where(AnswerOptionTable.c.QI_ID == q_id)
	                                            .where(AnswerOptionTable.c.QQ_ID == qq_id)
	                                            )
	                qo_ids = await result.fetchall()
	            for qo_id in qo_ids:
	                qo_id = qo_id.QO_ID
	                option_content = await self.get_option_content(q_id, qq_id, qo_id)
	                count = await self.get_option_count(q_id, qq_id, qo_id)
	                option_list.append(
	                    {
	                        "option_content": option_content,
	                        "option_count": count
	                    }
	                )
	            question_module = {
	                "question_content": question_content,
	                "option": option_list
	            }
	            return_list.append(question_module)
	        self.write(str(return_list))


# 4. 管理员模块设计

## 4.1 总体设计

[管理员模块设计](https://github.com/Wh1isper/QuestionnaireSystemDoc/blob/master/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF%E6%A6%82%E8%A6%81%E8%AE%BE%E8%AE%A1-2020.05.14-V1.0.md#4-%E7%AE%A1%E7%90%86%E5%91%98%E6%A8%A1%E5%9D%97)

以上包括整体流程和接口定义。

## 4.2 数据库设计

见上：用户管理模块、问卷管理模块

管理员账号密码不存储与数据库

## 4.3 模块设计

- 针对每一个API设计一个Handler类，见`/APIHandler/Admin/`
- 提供密码加密函数，见`/source/encrypt.py`
- 提供无状态HTTP服务，采用cookie方式暂存用户登录信息
- 管理员授权时长为浏览器打开，关闭即清除cookie，账户密码配置见config.py

### 路由表如下

	/api/v1/admin/login/ -----> <class 'APIHandler.Admin.AdminLoginHandler.AdminLoginHandler'>
	/api/v1/admin/logout/ -----> <class 'APIHandler.Admin.AdminLoginHandler.AdminLogoutHandler'>
	/api/v1/admin/userStateChange/ -----> <class 'APIHandler.Admin.AdminManageHandler.AdminUserStateChange'>
	/api/v1/admin/questionnaireStateChange/ -----> <class 'APIHandler.Admin.AdminManageHandler.AdminQuestionnaireStateChange'>
	/api/v1/admin/userList/ -----> <class 'APIHandler.Admin.AdminManageHandler.AdminGetUserList'>
	/api/v1/admin/questionnaireList/ -----> <class 'APIHandler.Admin.AdminManageHandler.AdminGetQuestionnaireList'>

## 4.4 核心代码及说明

暂未实现